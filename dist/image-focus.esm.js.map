{"version":3,"file":"image-focus.esm.js","sources":["../src/helpers/noop.ts","../src/helpers/assign.ts","../src/sharedStyles.ts","../src/retina.svg","../src/FocusPicker.ts","../src/helpers/debounce.ts","../src/FocusedImage.ts"],"sourcesContent":["// tslint:disable-next-line:no-empty\nexport const noop = () => {};\n","export function assign(target: any, ...sources) {\n  sources.forEach(source =>\n    Object.keys(source).forEach(key => (target[key] = source[key]))\n  );\n  return target;\n}\n","export const CONTAINER_STYLES = {\n  position: 'relative',\n  overflow: 'hidden',\n};\n\nexport const ABSOLUTE_STYLES = {\n  position: 'absolute',\n  top: '0',\n  right: '0',\n  bottom: '0',\n  left: '0',\n};\n","const img = \"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3e %3cg fill='none' fill-rule='evenodd'%3e %3ccircle id='a' cx='10' cy='10' r='10' fill='black' fill-opacity='.3' /%3e %3ccircle cx='10' cy='10' r='9' stroke='white' stroke-opacity='.8' stroke-width='2'/%3e %3c/g%3e%3c/svg%3e\";\n  export default img;","import { noop } from './helpers/noop';\nimport { assign } from './helpers/assign';\nimport { CONTAINER_STYLES } from './sharedStyles';\nimport { Focus, FocusPickerOptions } from './interfaces';\n\nimport retina from './retina.svg';\n\nconst IMAGE_STYLES = {\n  // Get rid of bottom padding from default display\n  display: 'block',\n  // Make image fill container\n  maxWidth: '100%',\n  // Prevent Android refresh on pull down\n  touchAction: 'none',\n};\n\nconst RETINA_STYLES = {\n  position: 'absolute',\n  cursor: 'move',\n\n  // Center the retina\n  transform: 'translate(-50%, -50%)',\n};\n\nconst DEFAULT_OPTIONS: FocusPickerOptions = {\n  onChange: noop,\n  retina,\n};\n\nexport class FocusPicker {\n  container: HTMLElement;\n  img: HTMLImageElement;\n  retina: HTMLImageElement;\n  focus: Focus;\n  private isDragging: boolean;\n  private options: FocusPickerOptions;\n\n  constructor(imageNode: HTMLImageElement, options: FocusPickerOptions = {}) {\n    // Merge options in\n    this.options = assign({}, DEFAULT_OPTIONS, options);\n\n    // Set up references\n    this.img = imageNode;\n    this.container = imageNode.parentElement;\n    this.retina = document.createElement('img');\n    this.retina.src = this.options.retina;\n    this.retina.draggable = false;\n    this.container.appendChild(this.retina);\n\n    // Set up image\n    this.img.draggable = false;\n\n    // Bind events\n    this.startListening();\n\n    // Assign styles\n    assign(this.img.style, IMAGE_STYLES);\n    assign(this.retina.style, RETINA_STYLES);\n    assign(this.container.style, CONTAINER_STYLES);\n\n    // Initialize Focus coordinates\n    this.focus = this.options.focus\n      ? this.options.focus\n      : {\n          x: parseFloat(this.img.getAttribute('data-focus-x')) || 0,\n          y: parseFloat(this.img.getAttribute('data-focus-y')) || 0,\n        };\n\n    // Set the focus\n    this.setFocus(this.focus);\n  }\n\n  public startListening() {\n    // Bind container events\n    this.container.addEventListener('mousedown', this.startDragging);\n    this.container.addEventListener('mousemove', this.handleMove);\n    this.container.addEventListener('mouseup', this.stopDragging);\n    this.container.addEventListener('mouseleave', this.stopDragging);\n    this.container.addEventListener('touchend', this.stopDragging);\n\n    // temporarily cast config objs until this issue is resolved\n    // https://github.com/Microsoft/TypeScript/issues/9548\n    this.container.addEventListener('touchstart', this.startDragging, {\n      passive: true,\n    } as any);\n    this.container.addEventListener('touchmove', this.handleMove, {\n      passive: true,\n    } as any);\n\n    this.img.addEventListener('load', this.updateRetinaPositionFromFocus);\n  }\n\n  public stopListening() {\n    this.container.removeEventListener('mousedown', this.startDragging);\n    this.container.removeEventListener('mousemove', this.handleMove);\n    this.container.removeEventListener('mouseup', this.stopDragging);\n    this.container.removeEventListener('mouseleave', this.stopDragging);\n    this.container.removeEventListener('touchend', this.stopDragging);\n    this.container.removeEventListener('touchstart', this.startDragging);\n    this.container.removeEventListener('touchmove', this.handleMove);\n    this.img.removeEventListener('load', this.updateRetinaPositionFromFocus);\n  }\n\n  public setFocus(focus: Focus) {\n    this.focus = focus;\n    this.img.setAttribute('data-focus-x', focus.x.toString());\n    this.img.setAttribute('data-focus-y', focus.y.toString());\n    this.updateRetinaPositionFromFocus();\n    this.options.onChange(focus);\n  }\n\n  private startDragging = (e: MouseEvent | TouchEvent) => {\n    e.preventDefault();\n    this.isDragging = true;\n    e instanceof MouseEvent\n      ? this.updateCoordinates(e.clientX, e.clientY)\n      : this.updateCoordinates(e.touches[0].clientX, e.touches[0].clientY);\n  };\n\n  private handleMove = (e: MouseEvent | TouchEvent) => {\n    e.preventDefault();\n    if (e instanceof MouseEvent) {\n      this.updateCoordinates(e.clientX, e.clientY);\n    } else {\n      const touch = e.touches[0];\n      const touchedEl = document.elementFromPoint(touch.pageX, touch.pageY);\n      touchedEl !== this.retina && touchedEl !== this.img\n        ? this.stopDragging()\n        : this.updateCoordinates(touch.clientX, touch.clientY);\n    }\n  };\n\n  private stopDragging = () => {\n    this.isDragging = false;\n  };\n\n  private calculateOffsetFromFocus() {\n    const { width, height } = this.img.getBoundingClientRect();\n    const offsetX = width * (this.focus.x / 2 + 0.5);\n    const offsetY = height * (this.focus.y / -2 + 0.5);\n    return { offsetX, offsetY };\n  }\n\n  private updateRetinaPositionFromFocus = () => {\n    this.updateRetinaPosition(this.calculateOffsetFromFocus());\n  };\n\n  private updateRetinaPosition = (offsets: {\n    offsetX: number;\n    offsetY: number;\n  }) => {\n    this.retina.style.top = `${offsets.offsetY}px`;\n    this.retina.style.left = `${offsets.offsetX}px`;\n  };\n\n  private updateCoordinates(clientX: number, clientY: number) {\n    if (!this.isDragging) return; // bail if not dragging\n    const { width, height, left, top } = this.img.getBoundingClientRect();\n\n    // Calculate FocusPoint coordinates\n    const offsetX = clientX - left;\n    const offsetY = clientY - top;\n    const x = (offsetX / width - 0.5) * 2;\n    const y = (offsetY / height - 0.5) * -2;\n\n    // TODO: Figure out an elegant way to use the setFocus API without\n    // having to recalculate the offset from focus\n    this.setFocus({ x, y });\n  }\n}\n","export function debounce(func: Function, debounceTime: number) {\n  let timeout: any;\n  return function debouncedFunction(...args) {\n    clearTimeout(timeout);\n    timeout = setTimeout(() => func(...args), debounceTime);\n  };\n}\n","import { debounce } from './helpers/debounce';\nimport { assign } from './helpers/assign';\nimport { Focus, FocusedImageOptions } from './interfaces';\nimport { CONTAINER_STYLES, ABSOLUTE_STYLES } from './sharedStyles';\n\nconst IMG_STYLES = {\n  // Set these styles in case the image dimensions\n  // are smaller than the container's\n  minHeight: '100%',\n  minWidth: '100%',\n};\n\nconst RESIZE_LISTENER_OBJECT_STYLES = {\n  height: '100%',\n  width: '100%',\n  border: 'none',\n\n  // set these styles to emulate \"visibility: hidden\"\n  // can't use visibility because it breaks the object\n  // events in Firefox\n  opacity: 0,\n  zIndex: -1,\n  pointerEvents: 'none',\n};\n\nconst DEFAULT_OPTIONS: FocusedImageOptions = {\n  debounceTime: 17,\n  updateOnWindowResize: true,\n  updateOnContainerResize: false,\n  containerPosition: 'relative',\n};\n\nexport class FocusedImage {\n  focus: Focus;\n  options: FocusedImageOptions;\n  container: HTMLElement;\n  img: HTMLImageElement;\n  resizeListenerObject: HTMLObjectElement;\n  listening: boolean = false;\n  debounceApplyShift: () => void;\n\n  constructor(\n    private imageNode: HTMLImageElement,\n    options: FocusedImageOptions = {}\n  ) {\n    // Merge in options\n    this.options = assign(DEFAULT_OPTIONS, options);\n\n    // Set up element references\n    this.img = imageNode;\n    this.container = imageNode.parentElement;\n\n    // Set up instance\n    if (this.img['__focused_image_instance__']) {\n      this.img['__focused_image_instance__'].stopListening();\n      this.img.removeEventListener('load', this.applyShift);\n    }\n    this.img['__focused_image_instance__'] = this;\n\n    // Add image load event listener\n    this.img.addEventListener('load', this.applyShift);\n\n    // Set up styles\n    assign(this.container.style, CONTAINER_STYLES);\n    this.container.style.position = this.options.containerPosition;\n    assign(this.img.style, IMG_STYLES, ABSOLUTE_STYLES);\n\n    // Create debouncedShift function\n    this.debounceApplyShift = debounce(\n      this.applyShift,\n      this.options.debounceTime\n    );\n\n    // Initialize focus\n    this.focus = this.options.focus\n      ? this.options.focus\n      : {\n          x: parseFloat(this.img.getAttribute('data-focus-x')) || 0,\n          y: parseFloat(this.img.getAttribute('data-focus-y')) || 0,\n        };\n\n    // Start listening for resize events\n    this.startListening();\n\n    // Set focus\n    this.setFocus(this.focus);\n  }\n\n  public setFocus = (focus: Focus) => {\n    this.focus = focus;\n    this.img.setAttribute('data-focus-x', focus.x.toString());\n    this.img.setAttribute('data-focus-y', focus.y.toString());\n    this.applyShift();\n  };\n\n  public applyShift = () => {\n    const { naturalWidth: imageW, naturalHeight: imageH } = this.img;\n    const {\n      width: containerW,\n      height: containerH,\n    } = this.container.getBoundingClientRect();\n\n    // Amount position will be shifted\n    let hShift = '0';\n    let vShift = '0';\n\n    if (!(containerW > 0 && containerH > 0 && imageW > 0 && imageH > 0)) {\n      return false; // Need dimensions to proceed\n    }\n\n    // Which is over by more?\n    const wR = imageW / containerW;\n    const hR = imageH / containerH;\n\n    // Reset max-width and -height\n    this.img.style.maxHeight = null;\n    this.img.style.maxWidth = null;\n\n    // Minimize image while still filling space\n    if (imageW > containerW && imageH > containerH) {\n      this.img.style[wR > hR ? 'maxHeight' : 'maxWidth'] = '100%';\n    }\n\n    if (wR > hR) {\n      hShift = `${this.calcShift(hR, containerW, imageW, this.focus.x)}%`;\n    } else if (wR < hR) {\n      vShift = `${this.calcShift(wR, containerH, imageH, this.focus.y, true)}%`;\n    }\n\n    this.img.style.top = vShift;\n    this.img.style.left = hShift;\n  };\n\n  public startListening() {\n    if (this.listening) {\n      return;\n    }\n    this.listening = true;\n    if (this.options.updateOnWindowResize) {\n      window.addEventListener('resize', this.debounceApplyShift);\n    }\n    if (this.options.updateOnContainerResize) {\n      const object = document.createElement('object');\n      assign(object.style, RESIZE_LISTENER_OBJECT_STYLES, ABSOLUTE_STYLES);\n      // Use load event callback because contentDocument doesn't exist\n      // until this fires in Firefox\n      object.addEventListener('load', (e: Event) =>\n        object.contentDocument.defaultView.addEventListener('resize', () =>\n          this.debounceApplyShift()\n        )\n      );\n      object.type = 'text/html';\n      object.setAttribute('aria-hidden', 'true');\n      object.tabIndex = -1;\n      this.container.appendChild(object);\n      object.data = 'about:blank';\n      this.resizeListenerObject = object;\n    }\n  }\n\n  public stopListening() {\n    if (!this.listening) {\n      return;\n    }\n    this.listening = false;\n    window.removeEventListener('resize', this.debounceApplyShift);\n    if (\n      this.resizeListenerObject &&\n      this.resizeListenerObject.contentDocument\n    ) {\n      this.resizeListenerObject.contentDocument.defaultView.removeEventListener(\n        'resize',\n        this.debounceApplyShift\n      );\n      this.container.removeChild(this.resizeListenerObject);\n      this.resizeListenerObject = null;\n    }\n  }\n\n  // Calculate the new left/top percentage shift of an image\n  private calcShift(\n    conToImageRatio: number,\n    containerSize: number,\n    imageSize: number,\n    focusSize: number,\n    toMinus?: boolean\n  ) {\n    const containerCenter = Math.floor(containerSize / 2); // Container center in px\n    const focusFactor = (focusSize + 1) / 2; // Focus point of resize image in px\n    const scaledImage = Math.floor(imageSize / conToImageRatio); // Can't use width() as images may be display:none\n    let focus = Math.floor(focusFactor * scaledImage);\n    if (toMinus) focus = scaledImage - focus;\n    let focusOffset = focus - containerCenter; // Calculate difference between focus point and center\n    const remainder = scaledImage - focus; // Reduce offset if necessary so image remains filled\n    const containerRemainder = containerSize - containerCenter;\n    if (remainder < containerRemainder)\n      focusOffset -= containerRemainder - remainder;\n    if (focusOffset < 0) focusOffset = 0;\n\n    return (focusOffset * -100) / containerSize;\n  }\n}\n"],"names":["noop","assign","target","sources","forEach","source","Object","keys","key","CONTAINER_STYLES","position","overflow","ABSOLUTE_STYLES","top","right","bottom","left","IMAGE_STYLES","display","maxWidth","touchAction","RETINA_STYLES","cursor","transform","DEFAULT_OPTIONS","onChange","retina","FocusPicker","imageNode","options","e","preventDefault","isDragging","MouseEvent","updateCoordinates","clientX","clientY","touches","touch","touchedEl","document","elementFromPoint","pageX","pageY","img","stopDragging","updateRetinaPosition","calculateOffsetFromFocus","offsets","style","offsetY","offsetX","container","parentElement","createElement","src","draggable","appendChild","startListening","focus","x","parseFloat","getAttribute","y","setFocus","addEventListener","startDragging","handleMove","passive","updateRetinaPositionFromFocus","stopListening","removeEventListener","setAttribute","toString","getBoundingClientRect","width","height","debounce","func","debounceTime","timeout","debouncedFunction","args","clearTimeout","setTimeout","IMG_STYLES","minHeight","minWidth","RESIZE_LISTENER_OBJECT_STYLES","border","opacity","zIndex","pointerEvents","updateOnWindowResize","updateOnContainerResize","containerPosition","FocusedImage","applyShift","imageW","naturalWidth","imageH","naturalHeight","containerW","containerH","hShift","vShift","wR","hR","maxHeight","calcShift","debounceApplyShift","listening","window","object","contentDocument","defaultView","type","tabIndex","data","resizeListenerObject","removeChild","conToImageRatio","containerSize","imageSize","focusSize","toMinus","containerCenter","Math","floor","focusFactor","scaledImage","focusOffset","remainder","containerRemainder"],"mappings":"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"}